\chapter[GraphApi]{GraphApi}
Para integração entre o Facebook e outros aplicativos externos é necessário o uso de uma API, a disponibilizada pela rede social em questão é a Graph. Ela é usada para que aplicativos externos possam realizar as requisições e envio de dados para a rede social, possibilitando consulta e gerência dos dados presentes nela. 

Usada para extrair e inserir dados da plataforma do Facebook por meio de requisições HTTP é possível realizar as mais diversas tarefas, entre elas estão a de publicar novas histórias, gerenciar anúncios e carregar fotos \cite{facebook2018b}.

\section{Token de acesso}
Seguindo os padrões de conformidade do protocolo OAuth 2.0, protocolo que provê um fluxo de autorização especifica para aplicações web, telefones móveis, entre outras \cite{oauth2018}. 

Para grande parte das requisições feitas a rede social é necessário o uso de um \textit{token} de acesso, ele funciona de maneira a autenticar o usuário sem a necessidade que um novo \textit{login} seja feito a cada requisição, além de identificar o aplicativo, o usuário que executará a ação e quais os dados serão possíveis acessar usando a Graph. Os \textit{token} de acesso são cadeia de caracteres usadas para realizar chamadas da Graph API. O tempo de duração deles podem ser curtos ou longos, variando de cerca de uma hora de duração a duração infinita.

Os \textit{tokens} são separados em quatro tipos, sendo \textit{token} de acesso do usuário, usado para alterações de uma conta de usuário especifica, os  \textit{token} de aplicativo, usado para que as requisições sejam feitas em nome do aplicativo, o \textit{token} de pagina, usado para realizar modificações em páginas e o \textit{token} de cliente, usado em aplicativos moveis e aplicações de computador.

No exemplo \ref{lst:tokenpagina} o conteúdo da variável \$graphNode será um JSON contendo as informações das páginas em que o usuário é administrador, informações como o \textit{token} de acesso de curta duração, id, nome e permissões. 

\begin{lstlisting}[caption={Obtendo Token de acesso a página},label={lst:tokenpagina}]
  $response = $fb->get(
    '/me/accounts',
    '{access-token}'
  );
  
  $graphNode = $response->getGraphNode();
\end{lstlisting}

Para se obter o \textit{token} com duração infinita é necessário uma requisição com passagem dos parâmetros ID único, ID secreto, e o uso do \textit{token} de curta duração obtido no \ref{lst:tokenpagina}, como mostra o exemplo \ref{lst:tokeninfinito}. Obtendo como retorno na variável \$graphNode um JSON com o \textit{token} de acesso vitalício.

\begin{lstlisting}[caption={Obtendo Token Infinito},label={lst:tokeninfinito}]
  $response = $fb->get(
    '/oauth/access_token?grant_type=fb_exchange_token&client_id={ID Unico}&client_secret={ID secreto}&fb_exchange_token={Token} ',
    '{access-token}'
  );
  $graphNode = $response->getGraphNode();
\end{lstlisting}

Cada linguagem possui a sua forma específica de obter o \textit{token} por meio do uso da SDK específica de cada uma. Além da chamada usando o SDK, para se gerar um \textit{token} é necessário um usuário autenticado.

\section{Autenticação}
O Facebook disponibiliza diversas ferramentas, entre elas está a de login com Facebook, com ela é possível um usuário se autenticar a aplicação usando o cadastro do Facebook. Além de oferece um sistema de autenticação multiplataforma e controle de acesso, ela provê a analise de permissões, definindo o que o usuário poderá usar. \cite{facebook2018c}

A ferramenta de login com o Facebook disponibilizada pela rede social funciona de forma a autenticar o usuário do aplicativo usando uma conta vinculada a rede social. Oferecendo também a possibilidade de recuperar dados comuns de quem está acessando a aplicação.

Para o funcionamento da ferramenta é necessário o envio de alguns parâmetros de identificação do aplicativo, tais como, o app\underline{{ }}id, app\underline{{ }}secret, default\underline{{ }}graph\underline{{ }}version, fileUpload, entre outros.

\begin{itemize}
\item O app\underline{{ }}id e o app\underline{{ }}secret são obrigatórios, os dois são IDs únicos para cada aplicativo vinculado a rede social, esses IDs são gerados pelo Facebook no momento da criação do aplicativo, entretanto, o app\underline{{ }}id é publico, enquanto o app\underline{{ }}secret é secreto.

\item O parâmetro defalt\underline{{ }}graph\underline{{ }}version, não é obrigatório. Ele irá identificar qual versão da Graph o seu programa irá usar. Caso não seja passado como parâmetro, o Facebook irá usar a ultima versão da API lançada.

\item O fileUpload não é obrigatório. Ele é o parâmetro necessário para informar se será enviado arquivo de imagem ou não.
\end{itemize}

No exemplo \ref{lst:appesdk}, usando código PHP, os parâmetros necessários para validação são passados em um array na variável \$newFacebook, essa variável é enviada para o SDK para então ser possível a conexão entre o SDK e o Facebook. Após a conexão com o SDK é possível a realização de requisições, essas requisição podem ser de \textit{GET}, \textit{POST} e \textit{DELETE} e são feitas a partir das chamadas da SDK, que no exemplo é a variável \$fb.

\begin{lstlisting}[caption={Conexão entre aplicativo e SDK},label={lst:appesdk}]
	$newFacebook = array(
		'app_id' => {ID},
		'app_secret' => {ID},
		'default_graph_version' => v2.10,
		'fileUpload' => true;
		)
	$fb = new \Facebook\Facebook ( $newFacebook );
\end{lstlisting}

Para realização de \textit{login} é necessário o uso de uma classe específica do SDK, a classe getRedirectLoginHelper() que possui o método getLoginUrl(). Nesse método é necessário passar o endereço de retorno após o \textit{login} juntamente com as permissões necessárias. O \textit{login} é possível usando o exemplo \ref{lst:solicitacaologin}

\begin{lstlisting}[caption={Solicitação de Login},label={lst:solicitacaologin}]
	$helper = $fb->getRedirectLoginHelper ();
	$permissions = [
		'email',
		'publish_actions',
		'manage_pages',
		'publish_pages'
	];

	$ip = $_SERVER['HTTP_HOST'];
	$loginUrl = $helper->getLoginUrl ( 'http://'.$ip.'/auth/callback', $permissions );
\end{lstlisting}

\maxwell {VERIFICAR CALLBACK}

\section{Permissões}
Um sistema de permissões é utilizando na Graph API para controle de acesso, controle de publicação e de edição de informações. Assim, para que alguma modificação na publicação por parte do modulo administrador possa ser efetivada, é necessário possuir as permissões adequadas. As permissões funcionam de forma a descrever como devem ser feitas as requisições para o completo uso do aplicativo, de acordo com a necessidade.

As permissões descrevem quais as possíveis ações podem ser feitas em cooperação com a Graph API, elas determinam quais tipos de dados pode-se gerenciar e quais as possíveis respostas o sistema pode retornar. A forma de solicitar permissões está descrita no exemplo \ref{lst:solicitacaologin}, na variável \$permissions.

O Facebook oferece diversas permissões, elas podem ser de leitura ou de escrita, cada uma poderá ser usada para se obter um determinado acesso a um determinado dado. As permissões podem ser usadas para que a Graph retorne ou envie dados específicos de usuário, tais como as permissões de email, \textit{user\underline{{ }}birthday}, \textit{user\underline{{ }}friends}, usadas para recuperar email, data de aniversário e amigos, respectivamente de um determinado usuário.

Não somente os usuários, as permissões também abrangem as páginas do Facebook, por exemplo, pode-se usar a \textit{manage\underline{{ }}pages}, a \textit{publish\underline{{ }}pages}, entre outras, usadas para gerenciar e criar novos conteúdos para as páginas, respectivamente.

As requisições também podem ser feitas diretas do navegador ou usando aplicações, entretanto, para o seu funcionamento, elas devem seguir um padrão para obtenção de uma resposta correta do servidor. Esse padrão de estrutura deve seguir os conceitos de um grafo.

\section{Requisições}

Para\cite{soares2014}, informalmente um grafo pode ser explicado como um conjunto de pontos que formam vértices e arestas, onde cada ponto é chamado de vértice e o par deles é chamado de arestas. A estrutura da Graph, segue esse conceito de um grafo, possuindo nós, bordas e campos, onde os nós são os vértices, bordas são as arestas e os campos são os elementos que os vértices ou as bordas possuem.

\subsection{Nó}
Os nós representam os vértices, eles podem ser os mais diversos elementos, sendo objetos individuais, onde cada página, usuário, comentário ou foto criada no Facebook é considerado um nó \cite{facebook2018b}. Cada nó possui uma identificação única chamada ID, para consulta-lo é necessário a identificação e o \textit{token} de acesso. A requisição do exemplo \ref{lst:requisicao1} é feito para recuperar alguns dados da página oficial do SID, o retorno na variável \$graphNode será um JSON contendo o nome e o ID da página.

\begin{lstlisting}[caption={Requisitando dados básicos de uma página},label={lst:requisicao1}]
  $response = $fb->get(
    '/415358248866659',
    '{access-token}'
  );
  $graphNode = $response->getGraphNode();
\end{lstlisting}

No exemplo \ref{lst:requisicao2}, a requisição é feita usando o parametro /me, que também representa um nó e irá retornar na variável \$graphNode um JSON com os dados básicos do usuário que está acessando, dados como nome e ID.

\begin{lstlisting}[caption={Requisitando dados básicos de um usuário},label={lst:requisicao2}]
  $response = $fb->get(
    '/me',
    '{access-token}'
  );
  $graphNode = $response->getGraphNode();
\end{lstlisting}

Já no exemplo \ref{lst:requisicao3}, a requisição é feita usando o ID único de uma publicação em uma página. O retorno na variável \$graphNode será dados referentes a essa publicação, tais como data de criação, nome e o ID.

\begin{lstlisting}[caption={Requisitando dados básicos de uma publicação},label={lst:requisicao3}]
  $response = $fb->get(
    '/415358248866659_511846152551201',
    '{access-token}'
  );
  $graphNode = $response->getGraphNode();
\end{lstlisting}

\subsection{Borda}
As arestas são as ligações entre os pontos, representado como bordas no Faceboook, ela é a ligação entre os nós, são as conexões entre uma coleção de objetos a um objeto único. As bordas representam o conjunto de fotos em uma página ou o conjunto de comentários em uma foto. Pode ser usado \textit{feed}, \textit{photos}, entre outros.

Para consultar todas as publicações da \textit{timeline} presentes na pagina oficial do SID é necessário seguir o exemplo \ref{lst:requisicao4} e o retorno será um JSON contendo a data de criação, a mensagem e o ID da borda que é o ID da página acrescido do ID único da publicação.

\begin{lstlisting}[caption={Requisitando todas as publicações de uma página},label={lst:requisicao4}]
  $response = $fb->get( 
    '/415358248866659/feed', 
    '{access-token}'
  );
  $graphNode = $response->getGraphNode();
\end{lstlisting}

Mas podemos também, por exemplo, buscar todos os álbuns presentes em uma pagina, como mostra o exemplo \ref{lst:requisicao5}.

\begin{lstlisting}[caption={Requisitando todas álbuns de uma página},label={lst:requisicao5}]
  $response = $fb->get( 
    '/415358248866659/photos', 
    '{access-token}'
  );
  $graphNode = $response->getGraphNode();
\end{lstlisting}

Como todas a publicações são consideradas nós, é possível buscar as arestas de cada uma delas, no exemplo \ref{lst:requisicao6} está sendo requisitado todos os comentários de uma publicação.

\begin{lstlisting}[caption={Requisitando todos os comentários de uma publicação},label={lst:requisicao6}]
  $response = $fb->get(
    '/492866217782528/comments',
    '{access-token}'
  );
$graphNode = $response->getGraphNode();
\end{lstlisting}

\subsection{Campo}
Já os campos, são usados para representar os dados de um objeto específico, dados que serão incluídos na resposta. Os dados podem ser data de aniversário de um usuário ou nome de uma página. Os atributos de campo, podem ser os mais diversos, tais como: \textit{comments},\textit{likes},\textit{link}, entre outros. No exemplo \ref{lst:requisicao7},é feito a requisição dos comentários presentes nas publicações feitas na \textit{timeline}, o retorno será um JSON com o ID da publicação acrescido de dados como data da criação, mensagem e ID dos comentários publicados em cada um das publicação.

\begin{lstlisting}[caption={Requisitar os comentários de todas as publicações da página},label={lst:requisicao7}]
  $response = $fb->get(
    '/415358248866659/feed?fields=comments',
    '{access-token}' 
  );
  $graphNode = $response->getGraphNode(); 
\end{lstlisting}

É possível também obter também outros dados, como o \textit{link} de uma publicação especifica, para isso é necessário obter o id único dela, no exemplo \ref{lst:requisicao8}, o retorno na variável \$graphNode será um JSON contendo os dados dos comentários, url e likes de uma publicação especifica.

\begin{lstlisting}[caption={Requsição de diversos atributos},label={lst:requisicao8}]
  $response = $fb->get(
   '/415358248866659_511846152551201?fields=comments,likes,link', 
   '{access-token}'
  );
  $graphNode = $response->getGraphNode();
\end{lstlisting}

Nos exemplos, a página do SID é um nó, usando o ID único dela é possível criar novas publicações que serão gerados um novo nó, cada publicaçãos é formada do ID da página acrescidos de um ID único da foto. Usando esse nó da publicação é possível recuperar comentários e \textit{likes}, por exemplo. \cite{facebook2018b}.

\subsection{Tipos de Requisição}
Além de requisições com o uso do GET, é possível realizar requisições usando POST e DELETE. O GET é usado para recuperar informações, o POST é usado para enviar dados e o DELETE é usado para deletar os dados.

Para envio de dados é necessário o uso do POST, ele pode ser usado para realizar uma nova publicação, envio de um comentário, entre outras.
\begin{lstlisting}[caption={Requsição de diversos atributos},label={lst:requisicao9}]
ESCREVER CODIGO POST
\end{lstlisting}

\begin{lstlisting}[caption={Requsição de diversos atributos},label={lst:requisicao10}]
ESCREVER CODIGO DELETE
\end{lstlisting}